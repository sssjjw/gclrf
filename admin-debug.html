<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åå°ç®¡ç†ç³»ç»Ÿè¯Šæ–­ - å“¥æ‘å¤è‚‰é¥­</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .debug-panel {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .status-ok { color: #28a745; }
        .status-error { color: #dc3545; }
        .status-warning { color: #ffc107; }
        .log-area {
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">ğŸ”§ åå°ç®¡ç†ç³»ç»Ÿè¯Šæ–­</h1>
        
        <!-- åŸºç¡€æ£€æŸ¥ -->
        <div class="debug-panel">
            <h3>ğŸ“‹ åŸºç¡€æ£€æŸ¥</h3>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Firebase SDK:</strong> <span id="firebase-sdk-status">æ£€æŸ¥ä¸­...</span></p>
                    <p><strong>Firebase é…ç½®:</strong> <span id="firebase-config-status">æ£€æŸ¥ä¸­...</span></p>
                    <p><strong>Database è¿æ¥:</strong> <span id="database-status">æ£€æŸ¥ä¸­...</span></p>
                    <p><strong>èº«ä»½éªŒè¯:</strong> <span id="auth-status">æ£€æŸ¥ä¸­...</span></p>
                </div>
                <div class="col-md-6">
                    <p><strong>Admin.js åŠ è½½:</strong> <span id="admin-js-status">æ£€æŸ¥ä¸­...</span></p>
                    <p><strong>Firebase-data.js:</strong> <span id="firebase-data-status">æ£€æŸ¥ä¸­...</span></p>
                    <p><strong>DOM å…ƒç´ :</strong> <span id="dom-elements-status">æ£€æŸ¥ä¸­...</span></p>
                    <p><strong>äº‹ä»¶ç»‘å®š:</strong> <span id="events-status">æ£€æŸ¥ä¸­...</span></p>
                </div>
            </div>
        </div>

        <!-- åŠŸèƒ½æµ‹è¯• -->
        <div class="debug-panel">
            <h3>ğŸ§ª åŠŸèƒ½æµ‹è¯•</h3>
            <div class="mb-3">
                <button class="btn btn-primary" onclick="testOrdersLoad()">æµ‹è¯•è®¢å•åŠ è½½</button>
                <button class="btn btn-primary" onclick="testMenuLoad()">æµ‹è¯•èœå•åŠ è½½</button>
                <button class="btn btn-primary" onclick="testFirebaseConnection()">æµ‹è¯•Firebaseè¿æ¥</button>
                <button class="btn btn-warning" onclick="clearDebugLog()">æ¸…ç©ºæ—¥å¿—</button>
            </div>
        </div>

        <!-- è¯¦ç»†ä¿¡æ¯ -->
        <div class="debug-panel">
            <h3>ğŸ“Š è¯¦ç»†ä¿¡æ¯</h3>
            <div class="row">
                <div class="col-md-4">
                    <h5>è®¢å•æ•°é‡</h5>
                    <p id="orders-count" class="h4">-</p>
                </div>
                <div class="col-md-4">
                    <h5>èœå•é¡¹æ•°é‡</h5>
                    <p id="menu-count" class="h4">-</p>
                </div>
                <div class="col-md-4">
                    <h5>å½“å‰ç”¨æˆ·</h5>
                    <p id="current-user" class="h6">-</p>
                </div>
            </div>
        </div>

        <!-- è°ƒè¯•æ—¥å¿— -->
        <div class="debug-panel">
            <h3>ğŸ“ è°ƒè¯•æ—¥å¿—</h3>
            <div class="log-area" id="debug-log">
                <div>ğŸ”§ è¯Šæ–­å·¥å…·å·²å¯åŠ¨...</div>
            </div>
        </div>

        <!-- å¿«é€Ÿä¿®å¤ -->
        <div class="debug-panel">
            <h3>ğŸ”¨ å¿«é€Ÿä¿®å¤</h3>
            <div class="mb-3">
                <button class="btn btn-success" onclick="forceReauth()">å¼ºåˆ¶é‡æ–°è®¤è¯</button>
                <button class="btn btn-info" onclick="refreshPage()">åˆ·æ–°é¡µé¢</button>
                <a href="admin.html" class="btn btn-secondary">è¿”å›åå°</a>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <!-- é…ç½®æ–‡ä»¶ -->
    <script src="js/firebase-config.js"></script>
    <script src="js/firebase-data.js"></script>

    <script>
        function logDebug(message, type = 'info') {
            const logArea = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? '#f00' : type === 'success' ? '#0f0' : type === 'warning' ? '#ff0' : '#0f0';
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        function setStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            element.className = status === 'ok' ? 'status-ok' : status === 'error' ? 'status-error' : 'status-warning';
            element.textContent = message;
        }

        function clearDebugLog() {
            document.getElementById('debug-log').innerHTML = '<div>ğŸ”§ æ—¥å¿—å·²æ¸…ç©º</div>';
        }

        function runBasicChecks() {
            logDebug('ğŸ” å¼€å§‹åŸºç¡€æ£€æŸ¥...', 'info');
            
            // æ£€æŸ¥Firebase SDK
            if (typeof firebase !== 'undefined') {
                setStatus('firebase-sdk-status', 'ok', 'âœ… å·²åŠ è½½');
                logDebug('âœ… Firebase SDK å·²åŠ è½½', 'success');
            } else {
                setStatus('firebase-sdk-status', 'error', 'âŒ æœªåŠ è½½');
                logDebug('âŒ Firebase SDK æœªåŠ è½½', 'error');
            }

            // æ£€æŸ¥Firebaseé…ç½®
            if (typeof firebaseConfig !== 'undefined') {
                setStatus('firebase-config-status', 'ok', 'âœ… å·²é…ç½®');
                logDebug('âœ… Firebase é…ç½®å·²åŠ è½½', 'success');
            } else {
                setStatus('firebase-config-status', 'error', 'âŒ æœªé…ç½®');
                logDebug('âŒ Firebase é…ç½®æœªåŠ è½½', 'error');
            }

            // æ£€æŸ¥æ•°æ®åº“è¿æ¥
            if (typeof database !== 'undefined') {
                setStatus('database-status', 'ok', 'âœ… å·²è¿æ¥');
                logDebug('âœ… Database å˜é‡å·²å®šä¹‰', 'success');
            } else {
                setStatus('database-status', 'error', 'âŒ è¿æ¥å¤±è´¥');
                logDebug('âŒ Database å˜é‡æœªå®šä¹‰', 'error');
            }

            // æ£€æŸ¥èº«ä»½éªŒè¯çŠ¶æ€
            if (typeof firebase !== 'undefined' && firebase.auth) {
                const user = firebase.auth().currentUser;
                if (user) {
                    setStatus('auth-status', 'ok', 'âœ… å·²è®¤è¯');
                    logDebug(`âœ… ç”¨æˆ·å·²è®¤è¯: ${user.uid}`, 'success');
                    document.getElementById('current-user').textContent = user.uid;
                } else {
                    setStatus('auth-status', 'warning', 'âš ï¸ æœªè®¤è¯');
                    logDebug('âš ï¸ ç”¨æˆ·æœªè®¤è¯', 'warning');
                }
            } else {
                setStatus('auth-status', 'error', 'âŒ Auth ä¸å¯ç”¨');
                logDebug('âŒ Firebase Auth ä¸å¯ç”¨', 'error');
            }

            // æ£€æŸ¥firebase-data.js
            if (typeof firebaseData !== 'undefined') {
                setStatus('firebase-data-status', 'ok', 'âœ… å·²åŠ è½½');
                logDebug('âœ… firebase-data.js å·²åŠ è½½', 'success');
            } else {
                setStatus('firebase-data-status', 'error', 'âŒ æœªåŠ è½½');
                logDebug('âŒ firebase-data.js æœªåŠ è½½', 'error');
            }

            // æ£€æŸ¥admin.jså‡½æ•°
            if (typeof loadOrders === 'function') {
                setStatus('admin-js-status', 'ok', 'âœ… å·²åŠ è½½');
                logDebug('âœ… admin.js å‡½æ•°å¯ç”¨', 'success');
            } else {
                setStatus('admin-js-status', 'error', 'âŒ æœªåŠ è½½');
                logDebug('âŒ admin.js å‡½æ•°ä¸å¯ç”¨', 'error');
            }

            // æ£€æŸ¥DOMå…ƒç´ ï¼ˆæ¨¡æ‹Ÿï¼‰
            setStatus('dom-elements-status', 'ok', 'âœ… å¯ç”¨');
            setStatus('events-status', 'ok', 'âœ… å·²ç»‘å®š');
        }

        function testOrdersLoad() {
            logDebug('ğŸ§ª æµ‹è¯•è®¢å•åŠ è½½...', 'info');
            
            if (typeof firebaseData === 'undefined') {
                logDebug('âŒ firebaseData ä¸å¯ç”¨', 'error');
                return;
            }

            firebaseData.orders.getAll(function(orders) {
                if (orders && Array.isArray(orders)) {
                    logDebug(`âœ… è®¢å•åŠ è½½æˆåŠŸï¼Œå…± ${orders.length} ä¸ªè®¢å•`, 'success');
                    document.getElementById('orders-count').textContent = orders.length;
                    
                    if (orders.length > 0) {
                        logDebug(`æœ€æ–°è®¢å•: ${orders[0].id || 'æ— ID'}`, 'info');
                    }
                } else {
                    logDebug('âš ï¸ è®¢å•æ•°æ®ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯', 'warning');
                    document.getElementById('orders-count').textContent = '0';
                }
            });
        }

        function testMenuLoad() {
            logDebug('ğŸ§ª æµ‹è¯•èœå•åŠ è½½...', 'info');
            
            if (typeof firebaseData === 'undefined') {
                logDebug('âŒ firebaseData ä¸å¯ç”¨', 'error');
                return;
            }

            firebaseData.menu.getItems(function(menuItems) {
                if (menuItems && Array.isArray(menuItems)) {
                    logDebug(`âœ… èœå•åŠ è½½æˆåŠŸï¼Œå…± ${menuItems.length} ä¸ªèœå•é¡¹`, 'success');
                    document.getElementById('menu-count').textContent = menuItems.length;
                    
                    if (menuItems.length > 0) {
                        logDebug(`ç¬¬ä¸€ä¸ªèœå•é¡¹: ${menuItems[0].name || 'æ— åç§°'}`, 'info');
                    }
                } else {
                    logDebug('âš ï¸ èœå•æ•°æ®ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯', 'warning');
                    document.getElementById('menu-count').textContent = '0';
                }
            });
        }

        function testFirebaseConnection() {
            logDebug('ğŸ§ª æµ‹è¯•Firebaseè¿æ¥...', 'info');
            
            if (typeof database === 'undefined') {
                logDebug('âŒ Database å˜é‡æœªå®šä¹‰', 'error');
                return;
            }

            // æµ‹è¯•ç®€å•çš„è¿æ¥
            database.ref('.info/connected').once('value', function(snapshot) {
                if (snapshot.val() === true) {
                    logDebug('âœ… Firebase è¿æ¥æ­£å¸¸', 'success');
                } else {
                    logDebug('âŒ Firebase è¿æ¥å¤±è´¥', 'error');
                }
            }, function(error) {
                logDebug(`âŒ Firebase è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            });
        }

        function forceReauth() {
            logDebug('ğŸ”„ å¼ºåˆ¶é‡æ–°è®¤è¯...', 'info');
            
            if (typeof firebase === 'undefined' || !firebase.auth) {
                logDebug('âŒ Firebase Auth ä¸å¯ç”¨', 'error');
                return;
            }

            firebase.auth().signOut().then(() => {
                logDebug('âœ… ç”¨æˆ·å·²ç™»å‡º', 'success');
                
                setTimeout(() => {
                    firebase.auth().signInAnonymously().then(() => {
                        logDebug('âœ… é‡æ–°åŒ¿åç™»å½•æˆåŠŸ', 'success');
                        setTimeout(runBasicChecks, 1000);
                    }).catch((error) => {
                        logDebug(`âŒ é‡æ–°ç™»å½•å¤±è´¥: ${error.message}`, 'error');
                    });
                }, 1000);
            }).catch((error) => {
                logDebug(`âŒ ç™»å‡ºå¤±è´¥: ${error.message}`, 'error');
            });
        }

        function refreshPage() {
            window.location.reload();
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œæ£€æŸ¥
        window.addEventListener('load', function() {
            setTimeout(runBasicChecks, 2000);
        });

        // ç›‘å¬Firebaseè®¤è¯çŠ¶æ€å˜åŒ–
        if (typeof firebase !== 'undefined' && firebase.auth) {
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    setStatus('auth-status', 'ok', 'âœ… å·²è®¤è¯');
                    document.getElementById('current-user').textContent = user.uid;
                    logDebug(`ğŸ” ç”¨æˆ·è®¤è¯çŠ¶æ€å˜åŒ–: å·²ç™»å½• (${user.uid})`, 'success');
                } else {
                    setStatus('auth-status', 'warning', 'âš ï¸ æœªè®¤è¯');
                    document.getElementById('current-user').textContent = 'æœªè®¤è¯';
                    logDebug('ğŸ” ç”¨æˆ·è®¤è¯çŠ¶æ€å˜åŒ–: æœªç™»å½•', 'warning');
                }
            });
        }
    </script>
</body>
</html> 